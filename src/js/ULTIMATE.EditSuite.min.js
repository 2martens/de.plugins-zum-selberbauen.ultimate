ULTIMATE.EditSuite={};ULTIMATE.EditSuite.SidebarMenu=Class.extend({_sidebarNavigation:null,_activeMenuItems:[],init:function(a){this._sidebarNavigation=$("aside.collapsibleMenu > div");this._activeMenuItems=a;this._prepareElements(a);},updateActiveItems:function(a){this._activeMenuItems=a;this._renderSidebar(a);},getActiveMenuItems:function(){return this._activeMenuItems;},_prepareElements:function(a){this._sidebarNavigation.find("legend").each($.proxy(function(b,c){$(c).click($.proxy(this._toggleItem,this));},this));this._sidebarNavigation.find("nav ul").each(function(){$(this).hide();});if(a.length===0){this._renderSidebar([]);}else{this._renderSidebar(a);}},_toggleItem:function(b){var a=$(b.currentTarget);a.parent().find("nav ul").stop(true,true).toggle("blind",{},200).end();a.toggleClass("active");},_renderSidebar:function(d){this._sidebarNavigation.find("li").removeClass("active");this._sidebarNavigation.find("legend").removeClass("active");this._sidebarNavigation.find("nav ul").each(function(){$(this).hide();});for(var e=0,a=d.length;e<a;e++){var b=d[e];if($.wcfIsset(b)){var c=$("#"+$.wcfEscapeID(b));if(c.getTagName()==="ul"){c.show().parents("fieldset").children("legend").addClass("active");}else{c.addClass("active");}}}}});ULTIMATE.EditSuite.AJAXIdentifiers={_identifiers:new WCF.Dictionary(),add:function(a,b){this._identifiers.add(a,b);},addObject:function(a){this._identifiers.addObject(a);},get:function(a){var b=this._identifiers.get(a);if(b===null){return a;}return b;}};ULTIMATE.EditSuite.AJAXLoading=Class.extend({_pageContainer:null,_pageJSContainer:null,_proxy:null,_jsAJAXProxy:null,_cachedData:{},_sidebarMenu:null,init:function(b,c,a){this._pageContainer=$("#"+$.wcfEscapeID(b));this._pageJSContainer=$("#"+$.wcfEscapeID(c));this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this),url:"index.php/AJAXEditSuite/?t="+SECURITY_TOKEN+SID_ARG_2ND});this._jsAJAXProxy=new WCF.Action.Proxy({success:$.proxy(this._successJSAJAX,this),url:"index.php/AJAXEditSuite/?t="+SECURITY_TOKEN+SID_ARG_2ND});this._sidebarMenu=a;this._initLinks();this._initCache();},_initLinks:function(){$("nav.menuGroupItems a").on("click",$.proxy(this._eventClick,this));$("#pageContentContainer").on("click","#pageContent a[data-controller]",$.proxy(this._eventClick,this));$(window).on("popstate",$.proxy(this._eventPopstate,this));},_eventClick:function(d){var a=$(d.currentTarget);d.preventDefault();var b=a.attr("href");b=b.replace(/^.*\/\/[^\/]+/,"");var c={controller:a.data("controller"),requestType:a.data("requestType")};history.pushState(c,"",b);if(this._cachedData[a.data("controller")]!=null){if(this._cachedData[a.data("controller")]["jsAJAXOnly"]){this._fireRequest(a.data("controller"),a.data("requestType"),b,"jsOnly");}else{if(this._cachedData[a.data("controller")]["ajaxOnly"]){this._fireRequest(a.data("controller"),a.data("requestType"),b,"fullHTML");}else{this._replaceHTML(a.data("controller"));}}}else{this._fireRequest(a.data("controller"),a.data("requestType"),b,"fullHTML");}},_eventPopstate:function(c){var b=null;var a=null;if(c.originalEvent.state==null){b=this._pageContainer.data("initialController");a=this._pageContainer.data("initialRequestType");}else{if(c.originalEvent.state.controller!=null){b=c.originalEvent.state.controller;a=c.originalEvent.state.requestType;}}if(b!=null){if(this._cachedData[b]!=null){if(this._cachedData[b]["jsAJAXOnly"]){this._fireRequest(b,a,"jsOnly");}else{if(this._cachedData[b]["ajaxOnly"]){this._fireRequest(b,a,"fullHTML");}else{this._replaceHTML(b);}}}else{this._fireRequest(b,a,"fullHTML");}}},_initCache:function(){var c=this._pageContainer.find("#pageContent").data("controller");var b=this._pageContainer.find("#pageContent").data("requestType");var a=$("#pageContent");var d=$("#pageJS");this._cachedData[c]={html:'<div id="pageContent" data-controller="'+c+'" data-request-type="'+b+'">'+a.html()+"</div>",activeMenuItems:this._sidebarMenu.getActiveMenuItems(),js:d.html(),jsAJAXOnly:d.data("ajaxOnly"),ajaxOnly:a.data("ajaxOnly")};},_fireRequest:function(e,g,a,h){var j=a.substr(a.indexOf("?")+1).split("&");var i=$.getQueryData(j);var f=(a.indexOf("?")!=-1?a.substr(0,a.indexOf("?")):a);var c=/\/(\d+)\/$/;var b=c.exec(f);if(b!==null){b=b[1];}if(b){i.id=b;}var d=$.extend(true,{controller:e,requestType:g,actionName:h,queryData:i},{});if(h=="jsOnly"){this._jsAJAXProxy.setOption("data",d);this._jsAJAXProxy.sendRequest();}else{this._proxy.setOption("data",d);this._proxy.sendRequest();}},_success:function(d,e,b){var a=$(d.html);var c=$(d.js);this._cachedData[d.controller]={};this._cachedData[d.controller]["activeMenuItems"]=d.activeMenuItems;this._cachedData[d.controller]["html"]='<div id="pageContent" data-controller="'+d.controller+'" data-request-type="'+d.requestType+'">'+a.find("#pageContent").html()+"</div>";this._cachedData[d.controller]["js"]=c.html();this._cachedData[d.controller]["jsAJAXOnly"]=c.data("ajaxOnly");this._cachedData[d.controller]["ajaxOnly"]=a.find("#pageContent").data("ajaxOnly");this._replaceHTML(d.controller);},_successJSAJAX:function(c,d,a){var b=$(c.js);this._cachedData[c.controller]["js"]=b.html();this._replaceHTML(c.controller);},_replaceHTML:function(controller){var script=$(this._cachedData[controller]["js"]);var scriptContent=script.html();eval(scriptContent);var rawFunctionName="init"+controller;eval(rawFunctionName+"()");this._pageContainer.html(this._cachedData[controller]["html"]);this._sidebarMenu.updateActiveItems(this._cachedData[controller]["activeMenuItems"]);script=$(this._cachedData[controller]["js"]);scriptContent=script.html();eval(scriptContent);rawFunctionName="postInit"+controller;eval(rawFunctionName+"()");}});ULTIMATE.EditSuite.Clipboard={_actionProxy:null,_actionObjects:{},_containers:null,_containerData:{},_hasMarkedItems:false,_markedObjectIDs:{},_page:"",_pageObjectID:0,_proxy:null,_trackedElements:{},_markAllCalls:0,init:function(d,b,e,c){this._page=d;this._actionObjects=e||{};this._hasMarkedItems=(b>0);this._pageObjectID=parseInt(c)||0;this._actionProxy=new WCF.Action.Proxy({success:$.proxy(this._actionSuccess,this),url:"index.php/ClipboardProxy/?t="+SECURITY_TOKEN+SID_ARG_2ND});this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this),url:"index.php/Clipboard/?t="+SECURITY_TOKEN+SID_ARG_2ND});this._containers=$(".jsClipboardContainer").each($.proxy(function(g,f){this._initContainer(f);},this));if(this._hasMarkedItems&&this._containers.length){this._loadMarkedItems();}var a=this;$("#pageContentContainer").on("click",".jsClipboardContainer .jsClipboardMarkAll",$.proxy(this._markAll,this));WCF.DOMNodeInsertedHandler.addCallback("ULTIMATE.EditSuite.Clipboard",function(){a._containers=$(".jsClipboardContainer").each($.proxy(function(g,f){a._initContainer(f);},a));});},_loadMarkedItems:function(){new WCF.Action.Proxy({autoSend:true,data:{containerData:this._containerData,pageClassName:this._page,pageObjectID:this._pageObjectID},success:$.proxy(this._loadMarkedItemsSuccess,this),url:"index.php/ClipboardLoadMarkedItems/?t="+SECURITY_TOKEN+SID_ARG_2ND});},reload:function(){if(this._containers===null){return;}this._loadMarkedItems();},_loadMarkedItemsSuccess:function(d,f,c){this._resetMarkings();var a;for(a in d.markedItems){if(d.markedItems.hasOwnProperty(a)){if(!this._markedObjectIDs[a]){this._markedObjectIDs[a]=[];}var b=d.markedItems[a];for(var e in b){if(b.hasOwnProperty(e)){this._markedObjectIDs[a].push(b[e]);}}this._containers.each($.proxy(function(h,g){var i=$(g);if(i.data("type")!==a){return;}i.find("input.jsClipboardItem").each($.proxy(function(l,k){var j=$(k);if(WCF.inArray(j.data("objectID"),this._markedObjectIDs[a])){j.prop("checked",true);j.parents(".jsClipboardObject").addClass("jsMarked");}},this));i.find("input.jsClipboardMarkAll").each(function(l,k){var j=true;i.find("input.jsClipboardItem").each(function(n,o){var m=$(o);if(!m.prop("checked")){j=false;}});if(j){$(k).prop("checked",true);}});},this));}}this._success(d,f,c);},_resetMarkings:function(){this._containers.each($.proxy(function(b,a){var c=$(a);this._markedObjectIDs[c.data("type")]=[];c.find("input.jsClipboardItem, input.jsClipboardMarkAll").prop("checked",false);c.find(".jsClipboardObject").removeClass("jsMarked");},this));},_initContainer:function(a){var c=$(a);var b=c.wcfIdentify();if(!this._trackedElements[b]){c.find(".jsClipboardMarkAll").data("hasContainer",b);this._markedObjectIDs[c.data("type")]=[];this._containerData[c.data("type")]={};$.each(c.data(),$.proxy(function(d,e){if(d.match(/^type(.+)/)){this._containerData[c.data("type")][WCF.String.lcfirst(d.replace(/^type/,""))]=e;}},this));this._trackedElements[b]=[];}else{c.find(".jsClipboardMarkAll").data("hasContainer",b);}c.find("input.jsClipboardItem").each($.proxy(function(f,e){var g=$(e);var d=g.wcfIdentify();if(!WCF.inArray(d,this._trackedElements[b])){this._trackedElements[b].push(d);g.data("hasContainer",b).click($.proxy(this._click,this));}},this));},_click:function(f){var b=$(f.target);var e=b.data("objectID");var h=(b.prop("checked"))?true:false;var d=[e];var a;if(b.data("hasContainer")){var g=$("#"+b.data("hasContainer"));a=g.data("type");}else{a=b.data("type");}if(h){this._markedObjectIDs[a].push(e);b.parents(".jsClipboardObject").addClass("jsMarked");}else{this._markedObjectIDs[a]=$.removeArrayValue(this._markedObjectIDs[a],e);b.parents(".jsClipboardObject").removeClass("jsMarked");}if(b.data("hasContainer")){var c=true;g.find("input.jsClipboardItem").each(function(j,i){var k=$(i);if(!k.prop("checked")){c=false;}});g.find(".jsClipboardMarkAll").each(function(i,j){if(c){$(j).prop("checked",true);}else{$(j).prop("checked",false);}});}this._saveState(a,d,h);},_markAll:function(d){var b=$(d.target);var c=[];var f=true;var a;if(this._markAllCalls){return;}this._markAllCalls=1;if(b.is("input")){f=b.prop("checked");}if(b.data("hasContainer")){var e=$("#"+b.data("hasContainer"));a=e.data("type");}else{a=b.data("type");}if(b.data("hasContainer")){e.find("input.jsClipboardItem").each($.proxy(function(h,g){var j=$(g);var i=j.data("objectID");if(f){if(!j.prop("checked")){j.prop("checked",true);this._markedObjectIDs[a].push(i);c.push(i);}}else{if(j.prop("checked")){j.prop("checked",false);this._markedObjectIDs[a]=$.removeArrayValue(this._markedObjectIDs[a],i);c.push(i);}}},this));if(f){e.find(".jsClipboardObject").addClass("jsMarked");}else{e.find(".jsClipboardObject").removeClass("jsMarked");}this._saveState(a,c,f);}},_saveState:function(b,c,a){this._proxy.setOption("data",{action:(a)?"mark":"unmark",containerData:this._containerData,objectIDs:c,pageClassName:this._page,pageObjectID:this._pageObjectID,type:b});this._proxy.sendRequest();},_success:function(data,textStatus,jqXHR){var $containers={};$(".jsClipboardEditor").each(function(index,container){var $container=$(container);var $types=eval($container.data("types"));for(var $i=0,$length=$types.length;$i<$length;$i++){var $typeName=$types[$i];$containers[$typeName]=$container;}var $containerID=$container.wcfIdentify();WCF.CloseOverlayHandler.removeCallback($containerID);$container.empty();});if(!data.items){return;}for(var $typeName in data.items){if(data.items.hasOwnProperty($typeName)){if(!$containers[$typeName]){continue;}var $container=$containers[$typeName];var $list=$container.children("ul");if($list.length==0){$list=$("<ul />").appendTo($container);}var $editor=data.items[$typeName];var $label=$('<li class="dropdown"><span class="dropdownToggle button">'+$editor.label+"</span></li>").appendTo($list);var $itemList=$('<ol class="dropdownMenu"></ol>').appendTo($label);for(var $itemIndex in $editor.items){if(!$editor.items.hasOwnProperty($itemIndex)){continue;}var $item=$editor.items[$itemIndex];var $listItem=$("<li><span>"+$item.label+"</span></li>").appendTo($itemList);$listItem.data("container",$container);$listItem.data("objectType",$typeName);$listItem.data("actionName",$item.actionName).data("parameters",$item.parameters);$listItem.data("internalData",$item.internalData).data("url",$item.url).data("type",$typeName);$listItem.click($.proxy(this._executeAction,this));}$('<li class="dropdownDivider" />').appendTo($itemList);$("<li><span>"+WCF.Language.get("wcf.clipboard.item.unmarkAll")+"</span></li>").appendTo($itemList).click($.proxy(function(){this._proxy.setOption("data",{action:"unmarkAll",type:$typeName});this._proxy.setOption("success",$.proxy(function(data,textStatus,jqXHR){this._containers.each($.proxy(function(index,container){var $container=$(container);if($container.data("type")==$typeName){$container.find(".jsClipboardMarkAll, .jsClipboardItem").prop("checked",false);$container.find(".jsClipboardObject").removeClass("jsMarked");return false;}},this));this._success(data,textStatus,jqXHR);this._proxy.setOption("success",$.proxy(this._success,this));},this));this._proxy.sendRequest();},this));WCF.Dropdown.initDropdown($label.children(".dropdownToggle"),false);}}this._markAllCalls=0;},_closeLists:function(){$(".jsClipboardEditor ul").removeClass("dropdownOpen");},_executeAction:function(e){var c=$(e.currentTarget);var d=c.data("url");if(d){window.location.href=d;}if(c.data("parameters").className&&c.data("parameters").actionName){if(c.data("parameters").actionName==="unmarkAll"||c.data("parameters").objectIDs){var b=c.data("internalData")["confirmMessage"];if(b){var a=c.data("internalData")["template"];if(a){a=$(a);}WCF.System.Confirmation.show(b,$.proxy(function(g){if(g==="confirm"){var f={};if(a&&a.length){$("#wcfSystemConfirmationContent").find("input, select, textarea").each(function(i,j){var h=$(j);f[h.prop("name")]=h.val();});}this._executeAJAXActions(c,f);}},this),"",a);}else{this._executeAJAXActions(c,{});}}}c.data("container").trigger("clipboardAction",[c.data("type"),c.data("actionName"),c.data("parameters")]);},_executeAJAXActions:function(d,e){e=e||{};var a=[];if(d.data("parameters").actionName!=="unmarkAll"){$.each(d.data("parameters").objectIDs,function(g,h){a.push(parseInt(h));});}var b={data:e,containerData:this._containerData[d.data("type")]};var f=d.data("internalData")["parameters"];if(f!==undefined){for(var c in f){if(!f.hasOwnProperty(c)){continue;}b[c]=f[c];}}new WCF.Action.Proxy({autoSend:true,data:{actionName:d.data("parameters").actionName,className:d.data("parameters").className,objectIDs:a,parameters:b},success:$.proxy(function(g){if(d.data("parameters").actionName!=="unmarkAll"){d.data("container").trigger("clipboardActionResponse",[g,d.data("type"),d.data("actionName"),d.data("parameters")]);}this._loadMarkedItems();},this)});if(this._actionObjects[d.data("objectType")]&&this._actionObjects[d.data("objectType")][d.data("parameters").actionName]){this._actionObjects[d.data("objectType")][d.data("parameters").actionName].triggerEffect(a);}},sendRequest:function(b){var a=$(b);this._actionProxy.setOption("data",{parameters:a.data("parameters"),typeName:a.data("type")});this._actionProxy.sendRequest();}};ULTIMATE.EditSuite.Button={};ULTIMATE.EditSuite.Button.Replacement=function(b,a,c){this.init(b,a,c);};ULTIMATE.EditSuite.Button.Replacement.prototype={_button:null,_buttonValue:"",_checkElement:null,_initialValueDateTime:null,_lastValueDateTime:null,_initialStatusID:0,_action:"",_saveMap:{0:"ultimate.button.saveAsDraft",1:"ultimate.button.saveAsPending"},_publishMap:{0:"ultimate.button.publish",1:"ultimate.button.schedule",2:"ultimate.button.update"},init:function(b,a,c){this._button=$("#"+$.wcfEscapeID(b));this._buttonValue=this._button.val();this._checkElement=$("#"+$.wcfEscapeID(a));this._action=c;if(this._action=="save"){this._initialStatusID=this._checkElement.val();}else{if(this._action=="publish"){var d=this._checkElement.datetimepicker("getDate");this._initialValueDateTime=d;this._lastValueDateTime=d;}}this._checkElement.change($.proxy(this._change,this));this._change();},_change:function(){if(this._action=="save"){var e=this._checkElement.val();var d=WCF.Language.get(this._saveMap[e]);if(e>=2){this._button.attr("disabled","disabled").prop("disabled",true);this._button.addClass("ultimateHidden");}else{if(e==0||e==1){this._button.removeClass("ultimateHidden");this._button.removeAttr("disabled").prop("disabled",false);this._button.val(d);}}}else{if(this._action=="publish"){var f=this._checkElement.datetimepicker("getDate");var c=new Date();var b=WCF.Language.get(this._publishMap[2]);var a=(b==this._buttonValue);if(f>c){if(a&&(this._lastValueDateTime>c)){return;}if(a&&this._initialValueDateTime>c){this._button.val(b);}else{this._button.val(WCF.Language.get(this._publishMap[1]));}}else{if(a&&(this._lastValueDateTime<c)){return;}if(a&&this._initialValueDateTime<c){this._button.val(b);}else{this._button.val(WCF.Language.get(this._publishMap[0]));}}this._lastValueDateTime=f;}}}};