$.fn.extend({getCaret1:function(){if(this.is("input")){}else{if(!this.is("textarea")){return -1;}}var c=0;var b=this.get(0);if(document.selection){this.focus();var a=document.selection.createRange();a.moveStart("character",-this.val().length);c=a.text.length;}else{if(b.selectionStart||b.selectionStart=="0"){c=parseInt(b.selectionStart);}}return c;},setCaret1:function(b){if(this.is("input")){}else{if(!this.is("textarea")){return false;}}var c=this.get(0);this.focus();if(document.selection){var a=document.selection.createRange();a.moveStart("character",b);a.moveEnd("character",0);a.select();}else{if(c.selectionStart||c.selectionStart=="0"){c.selectionStart=b;c.selectionEnd=b;}}return true;}});ULTIMATE.Tagging={};ULTIMATE.Tagging.MultipleLanguageInput=WCF.MultipleLanguageInput.extend({_buttonList:null,_listList:null,_wrapperList:null,_elementList:null,_hiddenInput:"",_hiddenContainer:null,_inputContainer:null,init:function(d,c,b,f,g){this._forceSelection=b;this._values=f;this._availableLanguages=g;this._buttonList={};this._listList={};this._wrapperList={};this._elementList={};this._hiddenInput="#"+$.wcfEscapeID(c);this._hiddenContainer=$("#tagSearchHidden");this._inputContainer=$("#tagSearchWrap");for(var e in this._availableLanguages){$element=$("#"+$.wcfEscapeID(d+e));this._elementList[e]=$element;$(this._hiddenInput+"Wrap"+e).detach().appendTo(this._hiddenContainer);}this._languageID=LANGUAGE_ID;this._element=this._elementList[this._languageID];$(this._hiddenInput+"Wrap"+this._languageID).detach().appendTo(this._inputContainer);if(this._element.length==0){console.debug("[WCF.MultipleLanguageInput] element id '"+d+"' is unknown");return;}$(".tagContainer").hide();$("#tagContainer"+this._languageID).show();var a=($.getLength(this._values)>0)?true:false;this._insertedDataAfterInit=a;this._prepareElement(a);this._element.parents("form").submit($.proxy(this._submit,this));$(this._hiddenInput+this._languageID).keydown($.proxy(this._inputKeydown,this));this._didInit=true;},_setVariables:function(){this._element=this._elementList[this._languageID];},_inputKeydown:function(a){$(this._hiddenInput+this._languageID).focus();if(a&&a.which==188){$(this._hiddenInput+this._languageID).val("");}},_prepareElement:function(a){var c=$("#tagSearchWrap");this._button=$('<p class="button dropdownToggle"><span>'+WCF.Language.get("wcf.global.button.disabledI18n")+"</span></p>").prependTo(c);this._list=$('<ul class="dropdownMenu"></ul>').insertAfter(this._button);if(this._button.nextAll("textarea").length){this._button.addClass("dropdownCaptionTextarea");}else{this._button.addClass("dropdownCaption");}for(var b in this._availableLanguages){$("<li><span>"+this._availableLanguages[b]+"</span></li>").data("languageID",b).click($.proxy(this._changeLanguage,this)).appendTo(this._list);}WCF.Dropdown.initDropdown(this._button,a);if(a||this._forceSelection){this._isEnabled=true;this._list.children("li").each($.proxy(function(d,f){var e=$(f);if(e.data("languageID")==this._languageID){e.trigger("click");}},this));}WCF.Dropdown.registerCallback(c.wcfIdentify(),$.proxy(this._handleAction,this));},_changeLanguage:function(a){var b=$(a.currentTarget);this._insertedDataAfterInit=true;$("#tagContainer"+this._languageID).hide();$(this._hiddenInput+"Wrap"+this._languageID).detach().appendTo(this._hiddenContainer);this._languageID=parseInt(b.data("languageID"));this._setVariables();$("#tagContainer"+this._languageID).show();$(this._hiddenInput+"Wrap"+this._languageID).detach().appendTo(this._inputContainer);b=this._list.children("li").filter(function(){return $(this).data("languageID")&&$(this).data("languageID")==this._languageID;});this._list.children("li").removeClass("active");b.addClass("active");this._button.children("span").addClass("active").text(this._availableLanguages[this._languageID]);if(this._didInit){$(this._inputHidden+this._languageID).blur().focus();}},_handleAction:function(a,b){if(b==="open"){this._enable();}else{this._closeSelection();}},_submit:function(){if(!this._isEnabled){return 3735928559;}}});ULTIMATE.Tagging.TagList=WCF.Tagging.TagList.extend({_languageID:0,init:function(e,a,b,d){this._languageID=d;this._allowCustomInput=true;this._maxLength=b;this._itemList=$(e);this._searchInput=$(a);this._data={};if(!this._itemList.length||!this._searchInput.length){console.debug("[WCF.EditableItemList] Item list and/or search input do not exist, aborting.");return;}this._objectID=this._getObjectID();this._objectTypeID=this._getObjectTypeID();this._itemList.find(".jsEditableItem").click($.proxy(this._click,this));if(!this._itemList.children("ul").length){$("<ul />").appendTo(this._itemList);}this._itemList=this._itemList.children("ul");this._form=this._itemList.parents("form").submit($.proxy(this._submit,this));if(this._allowCustomInput){var c=this;this._searchInput.keydown($.proxy(this._keyDown,this)).on("paste",function(){setTimeout(function(){c._onPaste();},100);});}this._data=[];this._search=new ULTIMATE.Tagging.TagSearch(a,this._languageID,$.proxy(this.addItem,this));this._itemList.addClass("tagList");this._searchInput.parents(".dropdown").data("preventSubmit",true);},_keyDown:function(b){if(this._keyDown1(b)){if(b===null){return true;}var a=b.which;if(a===8||a===27||a===13||a===46){return true;}else{if(a>36&&a<41){return true;}}return this._searchInput.val().length<this._maxLength;}return false;},_keyDown1:function(b){if(b===null||b.which===188){var a=$.trim(this._searchInput.val());if(b&&b.which===188){a=a.substring(0,this._searchInput.val().length);}if(a===""){return true;}this.addItem({objectID:0,label:a});if(b&&b.which===188){this._searchInput.val("");}else{this._searchInput.val("");}if(b!==null){b.stopPropagation();}return false;}return true;},_submit:function(){this._keyDown(null);var a=[];for(var c=0,b=this._data.length;c<b;c++){if(this._data[c]){a.push(this._data[c]);}}$('<input type="hidden" name="tags_i18n['+this._languageID+']" value="'+a.join(", ")+'" />').appendTo(this._form);}});ULTIMATE.Tagging.TagSearch=WCF.Tagging.TagSearch.extend({_className:"ultimate\\data\\tag\\TagAction",_languageID:0,init:function(b,c,e,a,d){if(e!==null&&e!==undefined&&!$.isFunction(e)){console.debug("[ULTIMATE.Tagging.TagSearch] The given callback is invalid, aborting.");return;}this._languageID=c;this._callback=(e)?e:null;this._excludedSearchValues=[];if(a){this._excludedSearchValues=a;}this._searchInput=$(b);if(!this._searchInput.length){console.debug("[ULTIMATE.Tagging.TagSearch] Selector '"+b+"' for search input is invalid, aborting.");return;}this._searchInput.keydown($.proxy(this._keyDown,this)).keyup($.proxy(this._keyUp,this));this._list=$('<ul class="dropdownMenu" />').insertAfter(this._searchInput);this._commaSeperated=(d)?true:false;this._oldSearchString=[];this._itemCount=0;this._itemIndex=-1;this._proxy=new WCF.Action.Proxy({showLoadingOverlay:false,success:$.proxy(this._success,this),autoAbortPrevious:true});if(this._searchInput.is("input")){this._searchInput.attr("autocomplete","off");}this._searchInput.blur($.proxy(this._blur,this));WCF.Dropdown.initDropdownFragment(this._searchInput.parent(),this._list);},_keyDown:function(a){if(a.which===$.ui.keyCode.ENTER){var b=this._searchInput.parents(".dropdown");if(b.data("disableAutoFocus")){if(this._itemIndex!==-1){a.preventDefault();}}else{if(b.data("preventSubmit")||this._itemIndex!==-1){a.preventDefault();}}}},_keyUp:function(c){switch(c.which){case 37:case 39:return;break;case 38:this._selectPreviousItem();return;break;case 40:this._selectNextItem();return;break;case 13:return this._selectElement(c);break;}var a=this._getSearchString(c);if(a===""){this._clearList(true);}else{if(a.length>=this._triggerLength){var b={data:{excludedSearchValues:this._excludedSearchValues,searchString:a,languageID:this._languageID}};this._searchInput.parents(".searchBar").addClass("loading");this._proxy.setOption("data",{actionName:"getSearchResultList",className:this._className,interfaceName:"wcf\\data\\ISearchAction",parameters:this._getParameters(b)});this._proxy.sendRequest();}else{this._clearList(false);}}},_success:function(d,f,c){this._clearList(false);this._searchInput.parents(".searchBar").removeClass("loading");if($.getLength(d.returnValues)){for(var e in d.returnValues){var a=d.returnValues[e];this._createListItem(a);}}else{if(!this._handleEmptyResult()){return;}}WCF.CloseOverlayHandler.addCallback("WCF.Search.Base",$.proxy(function(){this._clearList();},this));var b=this._searchInput.parents(".dropdown").wcfIdentify();if(!WCF.Dropdown.getDropdownMenu(b).hasClass("dropdownOpen")){WCF.Dropdown.toggleDropdown(b);}this._itemIndex=-1;if(!WCF.Dropdown.getDropdown(b).data("disableAutoFocus")){this._selectNextItem();}this._searchInput.focus();},_clearList:function(a){if(a&&!this._commaSeperated){this._searchInput.val("");}var b=this._searchInput.parent().wcfIdentify();WCF.Dropdown.getDropdown(b).removeClass("dropdownOpen");WCF.Dropdown.getDropdownMenu(b).removeClass("dropdownOpen");this._list.end().empty();WCF.CloseOverlayHandler.removeCallback("WCF.Search.Base");this._itemCount=0;this._itemIndex=-1;}});